/*
Copyright (c) 2022 Rune AI Inc.
All rights reserved.

This code is proprietary to Rune AI Inc.
The code may be used solely for accessing the Service provided by Rune AI Inc. following the Rune Terms of Service ("Terms") accessible at rune.ai/eula. You may not use this code for any use or purpose other than as expressly permitted by the Terms.
Restrictions set forth in the Terms include, but is not limited to, that you may not copy, adapt, modify, prepare derivative works based upon, distribute, license, sell, transfer, publicly display, publicly perform, transmit, stream, broadcast, attempt to discover any source code, reverse engineer, decompile, dissemble, or otherwise exploit the code as a whole or any portion of the code.
*/
"use strict";var e=require("rune-msgpack"),t=require("base-64");function r(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var n=r(e),o=r(t),a=function(){return a=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},a.apply(this,arguments)};function i(e,t,r,n){return new(r||(r=Promise))((function(o,a){function i(e){try{c(n.next(e))}catch(e){a(e)}}function u(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}c((n=n.apply(e,t||[])).next())}))}function u(e,t){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(u){return function(c){return function(u){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,u[0]&&(i=0)),i;)try{if(r=1,n&&(o=2&u[0]?n.return:u[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,u[1])).done)return o;switch(n=0,o&&(u=[2&u[0],o.value]),u[0]){case 0:case 1:o=u;break;case 4:return i.label++,{value:u[1],done:!1};case 5:i.label++,n=u[1],u=[0];continue;case 7:u=i.ops.pop(),i.trys.pop();continue;default:if(!(o=i.trys,(o=o.length>0&&o[o.length-1])||6!==u[0]&&2!==u[0])){i=0;continue}if(3===u[0]&&(!o||u[1]>o[0]&&u[1]<o[3])){i.label=u[1];break}if(6===u[0]&&i.label<o[1]){i.label=o[1],o=u;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(u);break}o[2]&&i.ops.pop(),i.trys.pop();continue}u=t.call(e,i)}catch(e){u=[6,e],n=0}finally{r=o=0}if(5&u[0])throw u[1];return{value:u[0]?u[1]:void 0,done:!0}}([u,c])}}}function c(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(e,t){var r,o;return void 0===t&&(t={}),l(n.encode(e,{maxDepth:null!==(r=t.maxDepth)&&void 0!==r?r:10,sortKeys:null===(o=t.sortKeys)||void 0===o||o}))}var l=function(e){for(var t=[],r=0,n=e.length;r<n;r++)t.push(String.fromCharCode(e[r]));return o.encode(t.join(""))},d=function(e){return e.charCodeAt(0)},f=function(e){return Uint8Array.from(o.decode(e),d)};function m(e,t){return function(e){return"string"==typeof e&&e.startsWith("RUNE_MSG_V2;")}(e)&&function(e){return t=e.slice("RUNE_MSG_V2;".length),n.decode(f(t));var t}(e)[t]||null}function v(e){return t={serverToGame:e},"".concat("RUNE_MSG_V2;").concat(s(t));var t}function p(e){var t,r,n={};try{for(var o=c(Object.values(e)),a=o.next();!a.done;a=o.next()){var i=a.value;i.playerId&&(n[i.playerId]={playerId:i.playerId,displayName:i.displayName,avatarUrl:i.avatarUrl})}}catch(e){t={error:e}}finally{try{a&&!a.done&&(r=o.return)&&r.call(o)}finally{if(t)throw t.error}}return n}var g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",y=g.length;function h(e){void 0===e&&(e=12);for(var t="",r=0;r<e;r++)t+=g.charAt(Math.floor(Math.random()*y));return t}function b(e){for(var t=0,r=1779033703^e.length;t<e.length;t++)r=(r=Math.imul(r^e.charCodeAt(t),3432918353))<<13|r>>>19;return r=Math.imul(r^r>>>16,2246822507),r=Math.imul(r^r>>>13,3266489909),(r^=r>>>16)>>>0}function O(e,t){if(!e)throw t instanceof Error?t:new Error(null!=t?t:"Assertion failed")}function S(e){return 2*e.length<1048576}function T(e){O(null!==e&&"object"==typeof e);return{gameState:e,stringifiedGameState:s(e,{sortKeys:!0})}}function w(e){if("object"!=typeof e||null===e)return!1;var t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)}function x(e,t,r){return void 0===r&&(r=""),b("".concat(r?r+"-":"").concat(e,"-").concat(t))}function C(e,t){return Math.floor(e/t)}function I(){return Math.floor(performance.now())}function E(e,t,r){return r*t-e}function k(e){for(var t=N(this,e),r=0;r<this.length;r++)this[r]=t[r];return this}function j(e,t){var r=e-t;return isNaN(r)?0:r}function N(e,t){if(void 0===t&&(t=j),e.length<=1)return e;var r=Math.floor(e.length/2),n=e.slice(0,r),o=e.slice(r);return function(e,t,r){var n=[];for(;e.length&&t.length;)r(e[0],t[0])<=0?n.push(e.shift()):n.push(t.shift());return n.concat(e,t)}(N(n,t),N(o,t),t)}function P(e,t,r,n){void 0===n&&(n="undefined"!=typeof globalThis?globalThis:window);var o="Rune"in n&&n.Rune;n.Rune=t;var a,i=n.Math.random;n.Math.random=(a=e,function(){var e=a+=1831565813;return e=Math.imul(e^e>>>15,1|e),(((e^=e+Math.imul(e^e>>>7,61|e))^e>>>14)>>>0)/4294967296});var u=n.Array.prototype.sort;n.Array.prototype.sort=k;try{return r()}finally{o?n.Rune=o:delete n.Rune,n.Math.random=i,n.Array.prototype.sort=u}}exports.canSwitchSpectatorToPlayer=function(e,t){return Object.keys(p(e)).length<t.maxPlayers},exports.createGameServer=function(e){var t=e.initialMsgLogger,r=e.gameId,n=e.network,o=e.logic,s=e.initialServerData,l=e.sendInitialStateSync,d=void 0!==l&&l,f=e.getSeedForPlayerId,g=void 0===f?function(e){return Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}:f,y=e.serverSeed,k=e.logicTimeoutDuration,j=void 0===k?100:k,N=e.sendStateHash,P=void 0===N||N,G=e.allowedGameTimeDelay,M=void 0===G?5e3:G,R=e.logServerClientGameTime,A=void 0!==R&&R,U=e.logNetworkMsg,_=void 0!==U&&U;return i(this,void 0,void 0,(function(){function e(e){Object.values(n.getUsers()).forEach((function(t){N(e,t.userId)}))}function l(e,t){var r,o=v(t);if(!S(o))return R(e,"Message sent to the clients is too big.");_&&e.info({serverToGameMsg:t},"SERVER_TO_GAME_BROADCAST_MSG"),n.broadcastMsg(e,o),K.context.gameOver&&(null===(r=n.onGameOver)||void 0===r||r.call(n,K.context.gameOver.reason))}function f(e){return e in K.random||(K.random[e]={seed:g(e),actionCount:0}),K.random[e]}function k(){return I()-Z}function N(e,t){var r=n.getUsers(),o=r[t].playerId,a=o?f(o):void 0,i={event:"stateSync",params:{game:K.game,players:p(r),gameContext:K.context,yourPlayerId:o,yourPlayerSeed:null==a?void 0:a.seed,yourPlayerActionCount:null==a?void 0:a.actionCount,serverSeed:y},orderNumber:K.context.orderNumber,serverGameTime:k(),uuid:h(),updateCount:K.updateCount};if(!S(v(i)))return K.game={},R(e,"State sync message is too big.");_&&e.info({serverToGameMsg:i},"SERVER_TO_GAME_SEND_MSG"),n.sendMsg(e,t,v(i))}function G(e){return function(e,t){return new Promise((function(r,n){var o=setTimeout((function(){n(new Error("Timed out after ".concat(t,"ms.")))}),t);e.then(r,n).finally((function(){return clearTimeout(o)}))}))}(e,j)}function R(e,t,r){var o;K.context.gameOver={reason:"err",players:p(n.getUsers())},r?e.error(r,t):e.error(t),Object.values(n.getUsers()).forEach((function(t){N(e,t.userId)})),null===(o=n.onGameOver)||void 0===o||o.call(n,"err")}function U(e,t,r){var o;return i(this,void 0,void 0,(function(){var a,i,s,l,d;return u(this,(function(u){switch(u.label){case 0:return u.trys.push([0,2,,3]),[4,G(e())];case 1:if(!(a=u.sent()))return[2,!1];if(i=a.game,(s=a.gameContext).gameOver&&(s.gameOver.players=p(n.getUsers())),"gameEnded"===(null===(o=s.gameOver)||void 0===o?void 0:o.reason)&&void 0!==s.gameOver.options)try{!function(e,t){var r,n;if(void 0!==e){O("object"==typeof e&&null!==e&&w(e),"must be an object"),O("players"in e,"must have players property"),O("object"==typeof e.players&&null!==e.players&&w(e.players),"players must be an object"),O(Object.keys(e.players).length>0,"players must not be empty"),O(Object.keys(e.players).sort().toString()===t.sort().toString(),"all game players must be mentioned in the players object");var o=Object.values(e.players);try{for(var a=c(o),i=a.next();!i.done;i=a.next()){var u=i.value;O("number"==typeof u&&!isNaN(u)&&Number.isInteger(u)&&u>=0||["WON","LOST"].includes(u),"only positive integers (scores), WON, or LOST are allowed as player results")}}catch(e){r={error:e}}finally{try{i&&!i.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}O(o.every((function(e){return["WON","LOST"].includes(e)}))||o.every((function(e){return"number"==typeof e})),"all players must have either WON or LOST or all players must have a score"),"delayPopup"in e&&O("boolean"==typeof e.delayPopup,"delayPopup must be a boolean")}}(s.gameOver.options,Object.values(p(n.getUsers())).map((function(e){return e.playerId})))}catch(e){if(e instanceof Error)return R(r,"GameOver options are invalid: ".concat(e.message)),[2,!1]}return l=b(T(i).stringifiedGameState),K.game=i,K.context.gameOver=s.gameOver,[2,{stateHash:l}];case 2:return d=u.sent(),R(r,t,d),[2,!1];case 3:return[2]}}))}))}function L(e,t,r){var c;return i(this,void 0,void 0,(function(){var s,d,m,v,p,g,y,h,b=this;return u(this,(function(O){switch(O.label){case 0:return r.sessionId!==K.context.sessionId?(e.warn({contextSessionId:K.context.sessionId,actionSessionId:r.sessionId},"Received message for different game session, ignoring it."),[2]):(s=n.getUsers()[t].playerId)!==r.playerId?(e.warn({networkPlayerId:s,actionPlayerId:r.playerId},"Received action from different playerId than provided in authentication. Ignoring the action"),[2]):((d=f(s)).actionCount++,m=d.actionCount,v=r.actionCount,K.context.gameOver?(e.warn("Trying to process action after game over, ignoring it."),[2]):"number"!=typeof r.randomSeed||"number"!=typeof v?(e.warn("Received action for user without seed or action count. Ignoring the action"),[2]):(v!=m&&e.warn("Unexpected player action count mismatch, allowing for now."),x(d.seed,v)!==r.randomSeed?(N(e,t),e.warn("Received action with wrong random seed. Ignoring the action and sending state sync"),[2]):(p=k(),A&&e.info({serverGameTime:p,clientGameTime:r.clientGameTime,diff:p-(null!==(c=r.clientGameTime)&&void 0!==c?c:0)},"ACTION_SERVER_CLIENT_GAME_TIME"),[4,U((function(){return i(b,void 0,void 0,(function(){var t;return u(this,(function(n){switch(n.label){case 0:return[4,o.runAction(e,{randomSeed:r.randomSeed,msPerTick:1e3,logicTick:C(p,1e3)},r.action,r.params,{game:K.game,playerId:s})];case 1:return(t=n.sent())?[2,t]:(e.warn("Action called Rune.invalidAction(), ignoring it"),[2,!1])}}))}))}),"Action ".concat(r.action," failed"),e)])));case 1:return(g=O.sent())?(K.context.orderNumber++,r.clientGameTime,y=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}(r,["clientGameTime"]),h=a(a({},y),{stateHash:P?g.stateHash:void 0,orderNumber:K.context.orderNumber,serverGameTime:k(),updateCount:K.updateCount}),l(e,h),[2]):[2]}}))}))}var D,J,V,H,q,W,F,K,z,B,Q,X,Y,Z,$,ee,te,re=this;return u(this,(function(c){switch(c.label){case 0:if(J=I(),V=0,H=!1,q=o.getConfig(),W=p(n.getUsers()),Object.keys(W).length<q.minPlayers)throw new Error("GameServer cannot start as there is not enough players");if(Object.keys(W).length>q.maxPlayers)throw new Error("GameServer cannot start due to too many players (some should be spectators and not in players object)");if(!y)throw new Error("GameServer cannot start without a serverSeed option");return F=function(e){return i(re,void 0,void 0,(function(){var n;return u(this,(function(a){switch(a.label){case 0:return n={},[4,G(o.runSetup(t,Object.keys(W),{randomSeed:x(y,0),logicTick:0,msPerTick:1e3}))];case 1:return[2,(n.game=a.sent(),n.context={gameOver:null,orderNumber:1,sessionId:e,gameId:r},n.random={},n.gameTime=0,n.updateCount=0,n)]}}))}))},s?[3,2]:[4,F(h())];case 1:return z=c.sent(),[3,6];case 2:return"sessionId"in s?[4,F(s.sessionId)]:[3,4];case 3:return B=c.sent(),[3,5];case 4:B=s,c.label=5;case 5:z=B,c.label=6;case 6:if(T((K=z).game),Q=I()-J,X=s&&"gameTime"in s?s.gameTime:0,Y=X+Q,Z=I()-Y,q.update){if($=C(k(),1e3),Math.abs(K.updateCount-$)>1)throw new Error("Update loop is out of sync with gameTime after redeployment. Logic Tick: ".concat($,", updateCount: ").concat(K.updateCount));K.updateCount!==$?D=setTimeout(n.queueUpdateLoop,0,{logicTick:$}):(ee=E(Y,C(k(),1e3)+1,1e3),D=setTimeout(n.queueUpdateLoop,ee,{logicTick:$+1}))}return d&&e(t),te={onMsg:function(e,t,r){return i(re,void 0,void 0,(function(){var n;return u(this,(function(o){return S(r)?(n=m(r,"gameToServer"))?(_&&e.info({gameToServerMsg:n},"GAME_TO_SERVER_MSG"),"REQUEST_STATE_SYNC"===n?[2,N(e,t)]:[2,L(e,t,n)]):[2,Promise.resolve()]:[2,R(e,"Received message is too big.")]}))}))},onUpdateLoop:function(t,r){return i(re,void 0,void 0,(function(){var a,i,c,s,d,f;return u(this,(function(u){switch(u.label){case 0:return H||K.context.gameOver?(D=void 0,[2]):(a=x(y,r.logicTick,"update-"),[4,U((function(){return o.runUpdate(t,{randomSeed:a,logicTick:r.logicTick,msPerTick:1e3},{game:K.game})}),"update failed",t)]);case 1:return i=u.sent(),K.updateCount++,i?k()-1e3*r.logicTick<0?[2,R(t,"server update loop is running faster than gameTime")]:K.context.gameOver?(e(t),null===(f=n.onGameOver)||void 0===f||f.call(n,K.context.gameOver.reason),D=void 0,[2]):(K.updateCount%5==0&&(c={event:"gameTimeUpdate",orderNumber:K.context.orderNumber,serverGameTime:k(),uuid:h(),updateCount:K.updateCount,params:{gameContext:K.context}},l(t,c)),s=r.logicTick+1,k()-1e3*s>M?[2,R(t,"Server update loop is too much behind game time.")]:(d=E(k(),s,1e3),D=setTimeout(n.queueUpdateLoop,d,{logicTick:s}),[2])):[2]}}))}))},onPlayerJoined:function(e,t){return i(re,void 0,void 0,(function(){var r,a,i;return u(this,(function(u){switch(u.label){case 0:return Object.keys(p(n.getUsers())).length>q.maxPlayers?[2,R(e,"GameServer is full (new players should be spectators and not in players object)")]:q.eventCallbacks.playerJoined?(V++,r=x(y,V),[4,U((function(){return o.runEvent(e,{randomSeed:r,msPerTick:1e3,logicTick:C(k(),1e3)},"playerJoined",t,{game:K.game})}),"playerJoined failed",e)]):[2,R(e,"onPlayerJoined() should only be called if callback is defined (otherwise new player should just be spectator)")];case 1:return(a=u.sent())?(K.context.orderNumber++,i={event:"playerJoined",params:{playerId:t,players:p(n.getUsers()),gameContext:K.context,randomSeed:r,stateHash:P?a.stateHash:void 0},orderNumber:K.context.orderNumber,serverGameTime:k(),uuid:h(),updateCount:K.updateCount},l(e,i),[2]):[2]}}))}))},onPlayerLeft:function(e,t){return i(re,void 0,void 0,(function(){var r,a,i,c,s;return u(this,(function(u){switch(u.label){case 0:return K.context.gameOver?(e.info("Trying to process playerLeft event after game over, ignoring it."),[2]):(r=n.getUsers(),0===Object.keys(r).length?[2]:(a=p(r),V++,i=x(y,V),!q.eventCallbacks.playerLeft||Object.keys(a).length<q.minPlayers?(K.context.gameOver={reason:q.eventCallbacks.playerLeft?"minPlayers":"playerLeft",players:a},[3,3]):[3,1]));case 1:return[4,U((function(){return o.runEvent(e,{randomSeed:i,msPerTick:1e3,logicTick:C(k(),1e3)},"playerLeft",t,{game:K.game})}),"playerLeft failed",e)];case 2:if(!(c=u.sent()))return[2];u.label=3;case 3:return K.context.orderNumber++,s={event:"playerLeft",params:{playerId:t,players:a,randomSeed:i,gameContext:K.context,stateHash:P?null==c?void 0:c.stateHash:void 0},orderNumber:K.context.orderNumber,serverGameTime:k(),uuid:h(),updateCount:K.updateCount},l(e,s),[2]}}))}))},getDataForSerialization:function(){return a(a({},K),{gameTime:k()})},getConfig:function(){return q},getSessionId:function(){return K.context.sessionId},getGameId:function(){return K.context.gameId},cleanup:function(){H=!0,D&&(clearTimeout(D),D=void 0)}},[2,te]}}))}))},exports.createRuneSDKForLogicRunner=function(e){function t(e){r.gameOverContext=null,r.logicContext=e}var r={setup:void 0,actions:void 0,events:void 0,logicContext:{msPerTick:0,logicTick:0,randomSeed:0},gameOverContext:null,initLogic:function(n){var o,a;r.gameConfig={minPlayers:n.minPlayers,maxPlayers:n.maxPlayers,eventCallbacks:{playerJoined:!!(null===(o=n.events)||void 0===o?void 0:o.playerJoined),playerLeft:!!(null===(a=n.events)||void 0===a?void 0:a.playerLeft)},update:!!n.update},r.setup=function(o,a){var i;t(a);var u=null!==(i=P(a.randomSeed,r,(function(){return n.setup(o)}),e))&&void 0!==i?i:{};if(r.gameOverContext)throw new Error("Rune.gameOver() is not allowed in setup function");return u},r.actions=Object.fromEntries(Object.entries(n.actions).map((function(n){var o=function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,a=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return i}(n,2),a=o[0],i=o[1];return[a,function(n,o,a){t(a);try{return P(a.randomSeed,r,(function(){return i(n,o)}),e),{game:o.game,gameContext:{gameOver:r.gameOverContext}}}catch(e){if(function(e){return"object"==typeof e&&null!==e&&"name"in e}(u=e)&&"RUNE_INVALID_ACTION"===u.name)return!1;throw e}var u}]}))),r.events=Object.fromEntries(["playerJoined","playerLeft"].map((function(o){return[o,function(a,i,u){return t(u),P(u.randomSeed,r,(function(){var e,t;null===(t=null===(e=n.events)||void 0===e?void 0:e[o])||void 0===t||t.call(e,a,{game:i.game})}),e),{game:i.game,gameContext:{gameOver:r.gameOverContext}}}]}))),n.update&&(r.update=function(o,a){return t(a),P(a.randomSeed,r,(function(){var e;null===(e=n.update)||void 0===e||e.call(n,{game:o.game})}),e),{game:o.game,gameContext:{gameOver:r.gameOverContext}}})},invalidAction:function(){return(e=new Error("Rune.invalidAction() was called")).name="RUNE_INVALID_ACTION",e;var e},gameOver:function(e){r.gameOverContext={reason:"gameEnded",options:e,players:{}}},gameTimeInSeconds:function(){var e,t,n,o;return n=null!==(e=r.logicContext.logicTick)&&void 0!==e?e:0,o=null!==(t=r.logicContext.msPerTick)&&void 0!==t?t:0,Math.floor(n*o/1e3)}};return r},exports.isNewUserSpectator=function(e,t,r){return Object.keys(p(e)).length>=t.maxPlayers||!t.eventCallbacks.playerJoined||r};
